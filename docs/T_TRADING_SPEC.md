# A股单票做T策略需求规范 v1.0（增强版）

版本: v1.0  
日期: 2025-12-17  
适用范围: Stock 项目单票高抛低吸策略（T+1）  
目标: 在 A 股 T+1 约束下，通过 120min KDJ 做 T 提升单票 Calmar（收益/回撤比）  

---

## 0. 总体定位

- 核心思路：先选一只“强势震荡偏上行”的牛股 → 建底仓 → 用 120min KDJ 低频做 T（高抛低吸）
- 目标函数：优先最大化 Calmar（年化收益 / 最大回撤），而非追求最大收益
- 交易频率：低频（每周 1–3 次有效操作）
- 市场范围：A 股全市场（含主板/创业板/科创板）；20%涨跌幅标的加重风险惩罚

---

## 1. 核心约束与边界定义

### 1.1 核心约束

| 约束 | 定义 |
|---|---|
| T+1 | 当天买入的仓位当天不可卖出（仅可卖“可卖仓/昨仓”） |
| 留 1 手 | 任何非风控卖出后，持仓股数必须 ≥ 100 股（允许“风控降仓”打破到 100 股，但不允许到 0） |
| 单票集中 | 只做 1 只股票，不分散 |
| 手动执行窗口 | 信号产生后的“下一根开盘”起 5 分钟内完成手动下单，否则视为错过（执行偏离） |

### 1.2 K线时间切分（写死，避免口径漂移）

- 120min 两根：`09:30–11:30`、`13:00–15:00`
- 信号产生时刻：`11:30` 与 `15:00`（对应 120min 收盘）

### 1.3 日线趋势口径（写死）

- `SMA60`：日线收盘价简单移动平均 SMA(60)
- `MA20`：日线收盘价简单移动平均 SMA(20)
- “趋势合格”条件：`MA20 > SMA60` 且 `SMA60` 不下行（如 `SMA60[t] >= SMA60[t-1]`）

### 1.4 绩效与回撤口径（写死）

- 回撤：策略净值曲线 peak-to-trough 最大回撤
- 年化：`(期末净值/期初净值)^(252/交易日数) - 1`
- 月收益：自然月，`月末净值/上月末净值 - 1`（期间按收盘市值计）

---

## 2. “接管日锚定”执行框架（v1.0）

### 2.1 接管日与基准价

- 接管日 `D0`：开始按本策略执行的第一天
- 基准价 `P0`：`D0` 的 `09:30` 开盘价（口径最清晰）

### 2.2 当日偏离（dev）定义（写死）

- `dev = (C_120 - P0) / P0`
- 其中 `C_120` 为信号产生时刻（11:30/15:00）对应 120min bar 的收盘价
- dev 只作为“触发门槛”，不单独决定交易方向

---

## 3. 选股评分框架（日线，输出 Top 20）

### 3.1 输入数据

- 日线 OHLCV（至少 252 交易日）
- 沪深300日线（用于相对强度 RS）
- 元数据：上市日期、板块（用于硬过滤/惩罚项）

### 3.2 硬过滤（不通过直接剔除）

| 条件 | 阈值 |
|---|---|
| 上市时长 | ≥ 2 年 |
| 流动性底线 | 近 60 日日均成交额 ≥ 1 亿元 |
| 数据完整性 | 近 120 日成交额为 0 或缺失天数占比 ≤ 5% |

### 3.3 加权评分（满分 100 - 惩罚项）

| 维度 | 权重 | 评分项（示例） |
|---|---:|---|
| 趋势强度 | 40 | 趋势门槛（10）+ 相对强度 RS120（0-15）+ 回撤质量 MDD120（0-15） |
| 可做T结构 | 35 | 回踩MA20次数（0-15，4-10次最佳）+ 修复率（0-10，>80%高分）+ 破MA60天数少（0-10） |
| 波动适配 | 15 | ATR%适配（0-10，1.5%-4%最佳）+ 极端波动日少（0-5） |
| 流动性质量 | 10 | 日均成交额分位数（0-10） |

### 3.4 惩罚项（0–30，直接扣分）

- 涨跌停过多：`min(15, 2×涨跌停天数 + 3×连板次数)`；20%涨跌幅标的 ×1.5
- 数据缺失/停牌：`min(10, 200×缺失比例)`
- 大缺口过多（可选）：0–5 分

### 3.5 输出

- Top 20 股票列表
- 分项得分表（便于人工复核）

---

## 4. 做T交易规则（120min，低频）

### 4.1 仓位结构与取整

- 底仓（Base）：60–80%（不轻易动）
- T仓：20–30%（分 2–3 档，每档 10%）
- 所有目标仓位按“向下取整到 100 股”，不足一手不交易
- T+1：卖出时只允许卖“可卖仓”（昨日及以前买入的股数）

### 4.2 震荡/趋势识别开关（v1.0 简化版）

定义 120min 的“有符号价距”：
- `gap = (C_120 - SMA20_120) / SMA20_120`
- `gap_abs = |gap|`

状态判定（写死）：
- 震荡：`gap_abs <= 5%` → 允许正常做T
- 强趋势上冲：`gap > 5%` 且**连续 2 根 120min bar**满足 → 不轻易高抛（避免卖飞）
- 弱趋势下跌：`gap < -5%` 且日线趋势不合格 → 禁止低吸（避免抄底）

### 4.3 KDJ 信号（120min）

KDJ 参数搜索空间：`(9,3,3)`、`(14,3,3)`

卖出（高抛减T）触发（需全部满足）：
1) `dev >= +3%`
2) `J > 80` 且 `K` 死叉 `D`
3) 价格确认：同根 120min 收盘 `C_120 < SMA20_120`

买入（低吸加回T）触发（需全部满足）：
1) `dev <= -3%`
2) `J < 20` 且 `K` 金叉 `D`
3) 价格确认：同根 120min 收盘 `C_120 > SMA20_120`

强趋势上冲限制（“不轻易高抛”落地规则）：
- 若处于“强趋势上冲”状态，则忽略高抛信号，除非同时满足：`dev >= +6%` 或 `J > 90`（二选一即可）再执行高抛。

弱趋势下跌限制：
- 若处于“弱趋势下跌”状态，则忽略所有低吸信号（不加仓）。

### 4.4 成交假设与手动执行对齐

回测/信号口径：
- 信号产生：120min 收盘（11:30/15:00）
- 成交时机：下一根 120min 开盘价（13:00 或次日 09:30）

涨跌停处理（写死）：
- 若下一根开盘处于涨停（无法买）或跌停（无法卖），该笔交易视为未成交并放弃（不顺延）

手动执行窗口（写死）：
- 下一根开盘后 5 分钟内完成下单；超时视为错过/偏离（需要记录）

---

## 5. 留 1 手与 Floor-only 再接回

### 5.1 留 1 手约束

- 非风控卖出后，持仓必须 ≥ 100 股
- 若因“卖出档位”受限导致无法完全按档卖出，则以“卖后仍 ≥ 100 股”为准，允许部分卖出或不卖

### 5.2 Floor-only 状态定义

进入条件：
- 任意“做T卖出”后，持仓被压到仅剩 100 股（1手）

状态行为：
- 不执行普通低吸加回规则
- 仅允许执行“再接回”规则进行重建

### 5.3 再接回规则（相对做T卖出价）

定义：
- `last_t_sell_price`：最近一次“做T卖出（高抛减T）”的实际成交价
- 注意：风控降仓的成交价不写入 `last_t_sell_price`

从 Floor-only 恢复的触发条件（需全部满足）：
1) 更低位：`price <= last_t_sell_price × 0.97`
2) `J < 10` 且 `K` 金叉 `D`

首次买入量：
- 买入 1 档（10%）

后续恢复：
- 回到普通低吸规则逐档补齐，且每次补仓间隔至少 1 根 120min

---

## 6. 风控规则（不允许到 0 的版本）

### 6.1 规则优先级

风控降仓到 1 手 > 冷却期 > 留 1 手 > 做T规则

### 6.2 风控触发（净值回撤口径）

- 硬风控：策略净值回撤 ≥ -20%  
  动作：将持仓降至 1 手（卖出多余仓位），进入冷却期

- 主风控：`close < SMA60` 且策略净值回撤 ≥ -15%  
  动作同上：降至 1 手，进入冷却期

> 说明：本版本明确“不允许到 0”，风控动作为“降到 1 手 + 冷却”。  

### 6.3 冷却期

- 时长：5 个交易日
- 解除：冷却期满 或 日线 `MA20 > SMA60` 恢复
- 冷却期间：不做任何交易

---

## 7. 回本后的“去留决策”（允许清仓到 0）

定义“回本”（写死）：
- 持仓综合盈亏（含已实现PnL + 未实现PnL − 全部交易成本）≥ 0

回本后的决策：
- 若股票仍“趋势合格”：可继续做T
- 若趋势不合格：允许清仓到 0，换更强势标的
- 若评分排名显著下滑：即使趋势合格也可考虑换股（机会成本）

推荐落地规则（可选）：
- 每周复评一次：若该股连续 2 次复评均不在 `large_cap` 评分 Top20，则允许清仓换股。

---

## 8. 回测实验说明（网格 + 闸门）

### 8.1 数据要求

| 数据 | 来源 | 窗口 |
|---|---|---|
| 日线 | 现有 cn_data | 用于选股与日线趋势过滤 |
| 60min | AKShare（分钟数据） | Top20 各 12 个月 |
| 120min | 由 60min 聚合 | 两根/日：09:30–11:30、13:00–15:00 |

### 8.2 参数网格

| 维度 | 取值 |
|---|---|
| Base | {60%, 70%, 80%} |
| T | {20%, 30%} |
| KDJ | {(9,3,3), (14,3,3)} |
| 阈值 | 高抛 J>80（强趋势上冲时额外门槛 dev>=+6% 或 J>90），低吸 J<20；Floor-only 再接回 J<10 |

### 8.3 三道闸门（合格筛选）

| 闸门 | 条件 |
|---|---|
| 稳定性 | ≥ 60% 月份收益 ≥ 0 |
| 样本量 | 交易次数 ≥ 10 |
| 成本敏感 | 成本 +5bp 后 Calmar 降幅 ≤ 30% 且仍为正 |

### 8.4 必看指标（含 Floor-only）

- 年化收益、最大回撤、Calmar、月胜率
- 交易次数、平均持仓时长、换手率
- 收益分解（Base 贡献 vs T 贡献）
- Floor-only 连续天数/比例（评估“更低再接回”是否过苛）
- 次优前 3 组参数（防过拟合）

---

## 9. 手动执行日志（v1.0 推荐最小字段）

每笔交易至少记录：

- 时间（信号时刻与下单时刻）
- 动作（减T/加回T/风控降仓/冷却开始/冷却结束）
- 股数（手数）
- 委托价与成交价（或未成交原因：涨停/跌停/错过窗口）
- 触发原因（dev、KDJ、价格确认、趋势/震荡状态、是否 Floor-only、last_t_sell_price）

---

## 10. 执行流程概览

1) [选股] large_cap 评分 → Top20  
2) [数据] Top20 拉取 60min（12个月）→ 聚合 120min  
3) [回测] 参数网格 × 三道闸门 → 合格集按 Calmar 排序  
4) [选定] 人工确认 1 只标的 + 1 组参数  
5) [信号] 每日 11:30/15:00 生成信号  
6) [执行] 下一根开盘 5 分钟内手动下单 + 记录日志  
7) [复盘] 每周复评：趋势合格/评分排名/回本去留  

