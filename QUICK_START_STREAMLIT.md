# Streamlit Web UI 快速启动

## 📋 前置条件

1. **已完成 HS300 选股系统基础配置**（参见 `QUICK_START_HS300.md`）
2. **Python 环境**: Python 3.8-3.10
3. **依赖库**: 已安装 `requirements_streamlit.txt`

## 🚀 快速启动

### 1. 安装依赖

```bash
pip install -r requirements_streamlit.txt
```

### 2. 启动 Web UI

```bash
streamlit run app.py
```

浏览器自动打开 `http://localhost:8501`

### 3. 首次使用流程

#### Step 1: 执行选股

1. 访问 **📊 每日选股** 页面
2. 设置参数（默认：预算10万，候选池5只）
3. 点击「🚀 执行选股」
4. 查看选股结果和持仓建议

#### Step 2: 创建虚拟持仓

1. 访问 **💼 模拟盘** 页面
2. 点击「🆕 创建新持仓」（初始资金10万）
3. 确认创建成功

#### Step 3: 执行再平衡

1. 在 **💼 模拟盘** 页面
2. 点击「🔄 执行再平衡」
3. 系统自动清仓旧持仓，买入最新选股结果
4. 查看持仓明细和交易历史

## 📱 页面功能说明

### 🏠 首页（系统概览）

- **系统指标**: 选股记录数、最新日期、持仓状态、交易数
- **最新选股**: Top候选股票、持仓建议、预算利用率
- **持仓概览**: 当前持仓明细、市值统计
- **快速操作**: 一键跳转到选股/模拟盘页面

### 📊 每日选股

**功能**:
- 执行选股策略（MA5/MA10 + 20日涨幅）
- 查看候选股票（按动量排序）
- 查看持仓建议（等权分配）
- 查看不可负担股票（预算不足）
- 历史选股记录查询

**参数配置**:
- `总预算`: 投资总额（最低2万）
- `候选池大小`: Top N只股票
- `动量阈值`: 20日涨幅门槛（百分比）

**输出**:
- JSON 文件: `data/daily/YYYY-MM-DD/selection.json`
- Markdown 报告（可选）

### 💼 模拟盘

**功能**:
- 创建/重置虚拟持仓
- 月度再平衡（自动清仓+重新买入）
- 持仓明细查看
- 交易历史查询
- 收益分析（已实现/未实现盈亏）

**月度再平衡流程**:
1. 卖出所有现有持仓（按当前价）
2. 根据最新选股结果等权买入
3. 记录所有交易到日志

**数据持久化**:
- 持仓状态: `data/portfolio/virtual.json`
- 交易日志: `data/portfolio/trades.jsonl`

## 📂 目录结构

```
Stock/
├── app.py                    # Streamlit 主入口
├── pages/                    # 多页面应用
│   ├── 1_📊_每日选股.py
│   └── 2_💼_模拟盘.py
├── backend/                  # 后端业务逻辑
│   ├── config.py            # 统一配置
│   ├── selector_api.py      # 选股API封装
│   ├── portfolio_manager.py # 持仓管理
│   └── data_access.py       # 数据访问层
├── components/               # UI组件
│   ├── stock_table.py       # 股票表格
│   └── portfolio_chart.py   # 收益图表
├── data/                     # 数据目录（统一管理）
│   ├── cache/               # 缓存（HS300成分股）
│   ├── daily/               # 每日选股结果
│   │   ├── 2025-01-15/
│   │   │   └── selection.json
│   │   └── latest.json → 软链接
│   └── portfolio/           # 持仓数据
│       ├── virtual.json     # 持仓状态
│       └── trades.jsonl     # 交易日志
└── scripts/                  # 原有脚本（零修改复用）
```

## ⚙️ 高级配置

### 自定义初始资金

在 **💼 模拟盘** 页面：
1. 展开「⚙️ 高级设置」
2. 修改「初始资金」（默认10万）
3. 点击「🆕 创建新持仓」

### 调整选股参数

在 **📊 每日选股** 页面：
- `总预算`: 根据实际可投资金额设置
- `候选池大小`: 建议 3-20 只（5-10只为佳）
- `动量阈值`:
  - 0% = 默认（温和趋势）
  - 5% = 更强势的上涨趋势
  - -5% = 允许轻微回调的股票

### 数据刷新频率

**选股频率**: 建议每日执行一次（交易日）
**再平衡频率**: 建议每月一次（月初/月末）

## 🔧 故障排查

### 问题1: Streamlit 启动失败

```bash
# 错误: ModuleNotFoundError: No module named 'streamlit'
# 解决: 安装依赖
pip install -r requirements_streamlit.txt
```

### 问题2: 选股失败「无数据」

```bash
# 错误: 未找到股票数据
# 原因: Qlib 数据目录为空
# 解决: 先执行数据下载
python scripts/batch_download.py --years 3
```

### 问题3: 再平衡失败「资金不足」

**现象**: 点击再平衡后提示资金不足
**原因**:
1. 最新选股结果的股票价格过高
2. 预算设置过低

**解决**:
1. 增加预算（修改选股参数）
2. 降低候选池大小 `--top 3`
3. 重新执行选股，使用更宽松的筛选条件

### 问题4: 价格数据缺失

**现象**: 持仓更新时显示「数据缺失，使用成本价」
**原因**: Qlib 数据不完整或股票已退市
**影响**: 收益率计算可能不准确
**解决**:
```bash
# 重新下载数据
python scripts/akshare-to-qlib-converter.py --symbol <股票代码> --years 3
```

## ⚠️ 重要说明

### 价格数据类型

✅ **已修复**（2025-01-10）: 当前使用**真实交易价格**（无复权）

**修复前** (Phase 2 初始版本):
- 使用后复权价格(hfq)，价格虚高5-10倍
- 示例: 真实 ¥50 → 显示 ¥500
- 预算利用率仅15-30%

**修复后** (当前版本):
- 使用真实交易价格，与交易软件一致
- 示例: 真实 ¥50 → 显示 ¥50
- 预算利用率提升至80-100%

**迁移说明**: 如果使用旧数据，请参见 [PRICE_FIX_MIGRATION.md](PRICE_FIX_MIGRATION.md) 重新下载数据

**自定义复权类型**:
```bash
# 真实价格（默认）
python scripts/akshare-to-qlib-converter.py --symbol 000001.SZ --adjust ""

# 前复权（历史连续性）
python scripts/akshare-to-qlib-converter.py --symbol 000001.SZ --adjust qfq

# 后复权（回测计算）
python scripts/akshare-to-qlib-converter.py --symbol 000001.SZ --adjust hfq
```

### 虚拟盘与实盘差异

| 项目 | 虚拟盘 | 实盘 |
|------|--------|------|
| 价格 | 真实交易价格（历史数据） | 实时行情价格 |
| 滑点 | 无 | 有（市价波动） |
| 手续费 | 无 | 有（佣金+印花税） |
| 流动性 | 无限 | 有限（大单可能无法成交） |
| 市场冲击 | 无 | 有（大单影响价格） |

**虚拟盘目的**: 策略验证、参数调优、收益跟踪
**实盘前提**: 至少运行1个月虚拟盘，确保策略稳定

## 📊 数据导出

### 导出选股结果

在 **📊 每日选股** 页面：
- Tab「🎯 候选股票」→ 点击「📥 下载候选股票CSV」

### 导出持仓明细

在 **💼 模拟盘** 页面：
- Tab「📦 持仓明细」→ 点击「📥 下载持仓明细CSV」

### 导出交易历史

在 **💼 模拟盘** 页面：
- Tab「🔄 交易历史」→ 点击「📥 下载交易历史CSV」

## 🎯 典型工作流程

### 每日操作（5分钟）

```bash
# 1. 启动应用
streamlit run app.py

# 2. 执行选股
# - 访问「📊 每日选股」
# - 点击「🚀 执行选股」
# - 查看结果

# 3. 查看持仓（可选）
# - 访问「💼 模拟盘」
# - 查看未实现盈亏
```

### 月度操作（10分钟）

```bash
# 1. 执行当月最后一次选股
# - 访问「📊 每日选股」
# - 执行选股

# 2. 执行再平衡
# - 访问「💼 模拟盘」
# - 点击「🔄 执行再平衡」
# - 确认清仓+重新买入

# 3. 导出数据
# - 下载持仓明细CSV
# - 下载交易历史CSV
# - 分析月度收益率
```

### 策略调优（30分钟）

```bash
# 1. 调整参数测试
# - 修改动量阈值（-5%, 0%, 5%, 10%）
# - 调整候选池（3, 5, 10, 20只）
# - 执行选股，观察候选变化

# 2. 对比历史结果
# - 查看「📊 每日选股」→「📚 历史选股记录」
# - 分析不同参数的选股差异

# 3. 更新配置
# - 选择最优参数组合
# - 更新 backend/config.py 默认值
```

## 📝 下一步扩展

Phase 2 MVP 完成后，可考虑：

1. **推送通知**（Phase 2C）
   - 企业微信 / 钉钉机器人
   - 每日选股结果自动推送
   - 再平衡提醒

2. **定时任务**
   - Cron 自动执行选股
   - 每月自动再平衡
   - 数据自动备份

3. **增强图表**
   - 使用 Plotly/Altair 替代原生图表
   - 收益率曲线图
   - 回撤分析图

4. **实盘接口**
   - 对接券商API
   - 真实价格数据
   - 自动下单功能

---

**版本**: Phase 2 MVP
**开发时间**: 2025-01-XX
**技术栈**: Streamlit + Pandas + JSON
**Git**: phase2-streamlit-ui

## 📞 支持

遇到问题请参考：
- `QUICK_START_HS300.md` - 基础选股系统说明
- `TODO.md` - 项目进度和已知问题
- `CLAUDE.md` - 代码库说明（供AI参考）
