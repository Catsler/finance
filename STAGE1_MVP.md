# Stage 1 MVP: 委托撮合系统

**目标**: 验证"限价买入 + 止损卖出"机制下，策略是否仍能盈利

**时间线**: 10天 (2025-01-10 ~ 2025-01-20)

**核心问题**: 引入真实的委托→撮合→成交流程后，策略收益是否≥12%？

---

## 📋 功能清单

### 1. 基础订单类型 (`backend/basic_orders.py`)

#### LimitOrder (限价单)
```python
LimitOrder(
    symbol='000001.SZ',
    direction='buy',  # 或 'sell'
    quantity=1000,    # 必须是100的倍数
    limit_price=10.50 # 限价（元）
)
```

**成交规则**:
- **买入**: 当日最低价 ≤ 限价时成交
- **卖出**: 当日最高价 ≥ 限价时成交
- **保守估计**: 需满足缓冲条件（默认0.5%）

#### StopOrder (止损单)
```python
StopOrder(
    symbol='000001.SZ',
    direction='sell',     # 通常是卖出
    quantity=1000,
    trigger_price=9.50    # 触发价（元）
)
```

**成交规则**:
- **触发**: 当日最低价 ≤ 触发价
- **成交**: 触发价 × (1 - 滑点)，默认滑点2%
- **保守估计**: 假设触发后价格继续下跌

#### Trade (成交记录)
```python
Trade(
    order_id='abc123',
    symbol='000001.SZ',
    direction='buy',
    fill_price=10.48,     # 实际成交价
    fill_quantity=1000,   # 实际成交量
    fill_time=datetime.now(),
    commission=3.14,      # 佣金（元）
    fill_type='limit'     # 'limit' 或 'stop'
)
```

---

### 2. 撮合引擎 (`backend/simple_matcher.py`)

#### SimpleConservativeMatcher

**设计原则**:
- ✅ **保守估计**: 宁可低估收益，也不过度乐观
- ✅ **可配置**: 所有阈值从YAML读取
- ✅ **最小化**: 只实现必需逻辑

**核心方法**:

##### `match_limit(order, bar) → Trade | None`
限价单撮合逻辑：

```python
# 买入条件
if bar['low'] * (1 + buffer) <= limit_price:
    成交 @ limit_price

# 卖出条件
if bar['high'] * (1 - buffer) >= limit_price:
    成交 @ limit_price
```

##### `match_stop(order, bar) → Trade | None`
止损单撮合逻辑：

```python
# 触发条件（卖出止损）
if bar['low'] <= trigger_price:
    成交 @ trigger_price * (1 - slippage)
```

**风控机制**:
1. **涨跌停板检测**
   - 涨幅 ≥ 9.5% 且收盘价 = 最高价 → 无法买入
   - 跌幅 ≤ -9.5% 且收盘价 = 最低价 → 无法卖出

2. **成交量限制**
   - 单笔不超过当日成交量的10%
   - 不足1手（100股）拒绝成交

3. **佣金计算**
   - 买入: `max(金额 × 0.03%, 5元)`
   - 卖出: `买入佣金 + 印花税（金额 × 0.1%）`

---

### 3. 配置系统 (`config/stage1_params.yaml`)

#### 撮合参数 (matching)
```yaml
stop_slippage: 0.02      # 止损滑点（2%）
  # 推荐区间: [0.01, 0.03]
  # 0.01 = 乐观（流动性好）
  # 0.02 = 中性（推荐）
  # 0.03 = 悲观（波动大）

limit_buffer: 0.005      # 限价缓冲（0.5%）
  # 推荐区间: [0.003, 0.01]
  # 0.003 = 大盘股（成交率高）
  # 0.005 = 一般股票（推荐）
  # 0.01 = 小盘股（流动性差）

max_volume_pct: 0.10     # 最大成交量比例（10%）
  # 推荐区间: [0.05, 0.20]
  # 资金<50万: 1.0（忽略限制）
  # 资金>100万: 0.05（避免冲击）
```

#### 策略参数 (strategy)
```yaml
entry_limit_premium: 0.01   # 买入溢价（1%）
  # 推荐区间: [0.005, 0.02]
  # 0.005 = 保守（成交率可能低）
  # 0.01 = 平衡（推荐）
  # 0.02 = 激进（成交率高但贵）

stop_loss_pct: 0.10         # 止损比例（-10%）
  # 推荐区间: [0.05, 0.15]
  # 0.05 = 激进（风控严格）
  # 0.10 = 平衡（推荐）
  # 0.15 = 保守（给反弹空间）

momentum_threshold: 0.0     # 动量阈值（0%）
  # 推荐区间: [-0.05, 0.10]
```

#### 佣金配置 (commission)
```yaml
rate: 0.0003        # 万三
minimum: 5.0        # 最低5元
stamp_tax: 0.001    # 千一（国家规定）
```

---

## 🧪 测试覆盖

### 单元测试 (`tests/test_simple_matcher.py`)

**8个测试用例**:
1. ✅ `test_limit_buy_success` - 限价买入成交
2. ✅ `test_limit_buy_fail_price` - 限价买入未成交（价格不满足）
3. ✅ `test_stop_sell_triggered` - 止损卖出触发
4. ✅ `test_stop_sell_not_triggered` - 止损未触发
5. ✅ `test_limit_up_reject_buy` - 涨停板拒绝买入
6. ✅ `test_limit_down_reject_sell` - 跌停板拒绝卖出
7. ✅ `test_volume_limit` - 成交量限制
8. ✅ `test_commission_calculation` - 佣金计算

**运行方式**:
```bash
python3 tests/test_simple_matcher.py
# 或
pytest tests/test_simple_matcher.py -v
```

---

## 🚀 使用指南

### Step 1: 运行回测

```bash
python scripts/stage1_minimal_backtest.py
```

**输出**:
- 终端: 实时进度和摘要
- 文件: `results/stage1_backtest_YYYYMMDD_HHMMSS.json`

**测试3个变体**:
1. **Baseline**: 无止损（直接清仓）
2. **Variant A**: 5%止损
3. **Variant B**: 10%止损

### Step 2: 生成对比报告

```bash
# 自动加载最新结果
python scripts/stage1_comparison.py

# 或指定文件
python scripts/stage1_comparison.py --input results/stage1_backtest_20250110_120000.json
```

**输出**:
- 文件: `results/stage1_comparison_YYYYMMDD_HHMMSS.md`
- 内容:
  - 策略对比表
  - 止损触发率分析
  - vs沪深300超额收益
  - 参数优化建议
  - 达标判断（≥12%）

### Step 3: 查看结果

```bash
# 查看最新对比报告
ls -lt results/stage1_comparison_*.md | head -1 | awk '{print $NF}' | xargs cat
```

---

## 📊 回测设计

### 数据范围
- **年份**: 2023（震荡市验证）
- **股票池**: medium_cap（20只）
- **调仓**: 月度（每月最后一个交易日）
- **选股规则**: MA5 > MA10 + 20日涨幅 > 0%

### 交易流程

#### 建仓
1. **选股** - 每月末筛选满足条件的股票（最多20只）
2. **限价买入**:
   ```
   限价 = 昨收价 × (1 + 溢价1%)
   使用当日K线撮合
   ```
3. **成交后**:
   - 扣除成本（成交金额 + 佣金）
   - 建立持仓记录
   - 设置止损单（如果启用）

#### 止损检查
- **检查频率**: 每个交易日
- **触发条件**: 当日最低价 ≤ 止损价
- **成交处理**:
  ```
  成交价 = 止损价 × (1 - 滑点2%)
  收回资金 = 成交金额 - 佣金 - 印花税
  ```

#### 清仓
- **时机**: 下一调仓日
- **价格**: 当日收盘价（简化）
- **资金**: 用于下一期建仓

---

## ✅ 成功标准

### 主要指标
| 指标 | 目标 | 说明 |
|------|------|------|
| **总收益** | ≥ 12% | 核心验收标准 |
| **止损触发率** | 15-25% | 过低=止损宽松，过高=止损过频 |
| **vs沪深300** | > 0% | 超额收益为正 |

### 判定逻辑
```
if 最佳变体收益 >= 12%:
    ✅ PASSED → 进入Stage 2
else:
    ❌ FAILED → 调整参数重新验证
```

---

## 🔧 参数调优

### 场景1: 收益不达标（<12%）

**可能原因**:
1. 撮合过于保守
2. 止损过频
3. 买入溢价偏高

**调整建议**:
```yaml
matching:
  stop_slippage: 0.015  # 从0.02 → 0.015
  limit_buffer: 0.003   # 从0.005 → 0.003

strategy:
  entry_limit_premium: 0.005  # 从0.01 → 0.005
  stop_loss_pct: 0.12         # 从0.10 → 0.12（更宽松）
```

### 场景2: 止损触发率过高（>30%）

**调整建议**:
```yaml
strategy:
  stop_loss_pct: 0.15  # 从0.10 → 0.15
```

### 场景3: 止损触发率过低（<10%）

**说明**: 止损设置过宽松，风控不足

**调整建议**:
```yaml
strategy:
  stop_loss_pct: 0.08  # 从0.10 → 0.08
```

---

## 🚧 已知限制

### 1. 日线数据限制
- **问题**: 无法精确反映盘中价格变化
- **影响**: 止损触发时机可能偏差
- **缓解**: 保守滑点（2%）补偿不确定性

### 2. 撮合简化
- **忽略**: 挂单深度、大单冲击、分笔成交
- **适用**: 小资金（<50万）、流动性好的股票
- **不适用**: 大资金、小盘股

### 3. 佣金模型
- **假设**: 固定佣金率（万三）
- **现实**: 可能有滑点、交易所费用
- **建议**: 实盘前咨询券商实际费率

---

## 📈 下一步（Stage 2）

### 如果Stage 1 PASSED（≥12%）

**Stage 2功能扩展** (预计10天):
1. **止盈单** (TakeProfit Order)
   - 目标收益触发（如+20%）
   - 配置: `take_profit_pct`

2. **移动止损** (Trailing Stop)
   - 跟随最高价上移
   - 配置: `trailing_stop_pct`

3. **OCO逻辑** (One-Cancels-Other)
   - 止损/止盈二选一
   - 提高资金利用率

4. **风险标注系统**
   - 标记高风险交易
   - 预警机制

### 如果Stage 1 FAILED（<12%）

**优先调试**:
1. 调整配置参数（见"参数调优"章节）
2. 对比phase6d无委托版本收益
3. 分析具体亏损案例
4. 考虑是否需要分钟级数据

---

## 📂 文件结构

```
Stock/
├── config/
│   └── stage1_params.yaml          # 配置文件（★核心）
│
├── backend/
│   ├── basic_orders.py             # 订单类型定义
│   └── simple_matcher.py           # 撮合引擎
│
├── tests/
│   └── test_simple_matcher.py      # 单元测试
│
├── scripts/
│   ├── stage1_minimal_backtest.py  # 回测脚本
│   └── stage1_comparison.py        # 对比报告生成
│
├── results/
│   ├── stage1_backtest_*.json      # 回测结果JSON
│   └── stage1_comparison_*.md      # 对比报告Markdown
│
└── STAGE1_MVP.md                   # 本文档
```

---

## 🎓 关键概念

### 保守撮合
**定义**: 在不确定情况下，倾向于"不成交"或"更差的价格成交"

**示例**:
```python
# 限价买入 limit_price=11.45, 当日最低价=11.40
# 直接比较: 11.40 <= 11.45 ✓ 成交
# 保守估计: 11.40 * 1.005 = 11.457 > 11.45 ✗ 不成交
```

**原因**: 日线数据无法精确知道成交时机，保守缓冲模拟真实滑点

### 止损滑点
**定义**: 止损触发后，实际成交价比触发价更差

**示例**:
```python
# 止损价=10.00，触发后价格继续下跌
# 触发价: 10.00
# 实际成交: 10.00 * (1 - 0.02) = 9.80
# 滑点损失: -2%
```

**原因**:
1. 市场快速变化
2. 流动性不足
3. 跌停板无法卖出

### 成交量限制
**定义**: 单笔交易量不超过市场成交量的一定比例

**示例**:
```python
# 当日成交量=50000股，限制比例=10%
# 最大可成交: 50000 * 0.10 = 5000股
# 如果委托10000股，只能成交5000股
```

**原因**: 大单可能冲击市场价格（价格滑点）

---

## 💡 常见问题

### Q1: 为什么不用分钟级数据？
**A**: Stage 1优先验证核心链路（委托→撮合→成交），日线数据足够：
- ✅ 开发速度快（10天 vs 21天）
- ✅ 数据获取简单
- ✅ 保守估计风险可控

如果Stage 1通过，Stage 2可考虑引入分钟数据。

### Q2: 保守撮合会低估收益吗？
**A**: 是的，这是设计目标：
- **宁可低估**: 如果保守估计下仍能盈利≥12%，说明策略真实有效
- **避免过拟合**: 过于乐观的假设容易导致实盘亏损

### Q3: 止损触发率多少合适？
**A**:
- **15-25%**: 健康范围，风控有效但不过度
- **<10%**: 止损过宽松，风险控制不足
- **>30%**: 止损过频，可能吃掉收益

### Q4: 如果3个变体都不达标怎么办？
**A**: 按优先级调试：
1. **先放宽撮合限制** (`limit_buffer` 0.005→0.003)
2. **再降低滑点** (`stop_slippage` 0.02→0.015)
3. **最后调整策略** (`stop_loss_pct` 0.10→0.12)

如果仍不达标，说明"限价+止损"对该策略损伤过大，需重新设计。

### Q5: 可以用于实盘吗？
**A**: ⚠️ **不建议直接用于实盘**
- Stage 1仅验证可行性（≥12%）
- 需要Stage 2补充止盈、风险标注
- 建议小资金（1-5万）试运行1-2个月

---

## 📞 技术支持

遇到问题请参考：
1. **单元测试**: `python3 tests/test_simple_matcher.py`
2. **配置检查**: `cat config/stage1_params.yaml`
3. **日志输出**: 回测脚本会打印实时进度
4. **对比报告**: 查看 `results/stage1_comparison_*.md`

---

**版本**: Stage 1 MVP v1.0.0
**完成日期**: 2025-01-10
**代码量**: ~380行（配置80 + 订单120 + 撮合180）
**下一阶段**: Stage 2 (止盈+移动止损+OCO)
